<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>s-cadnano</title>

    <link href="packages/codemirror/codemirror.css" rel="stylesheet">
    <link href="packages/codemirror/addon/hint/show-hint.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/favicon.ico">

    <script src="external-libs/svg-pan-zoom.min.js"></script>
    <script src="external-libs/hammer.min.js"></script>

    <script src="external-libs/pablo.js"></script>

<!--    <script src="external-libs/panzoom.min.js"></script>-->
<!--    <script src="external-libs/panzoom.js"></script>-->

<!--    <script src="external-libs/brython.js"></script>-->
<!--    <script src="external-libs/brython_stdlib.js"></script>-->

<!--    <script src="external-libs/pyodide/pyodide.js"></script>-->

    <!--    the documentation doesn't say it, but we need to include this reference to split.min.js -->
<!--    <script src="packages/split/split.min.js"></script>-->

    <script src="external-libs/simpledrag.js"></script>

    <script src="splitpane.js"></script>

    <script src="packages/codemirror/codemirror.js"></script>
    <script src="packages/codemirror/mode/python/python.js"></script>
</head>

<body>

<!--<button id="compile">Compile</button>-->

<div id="top-container"></div>


<script src="packages/react/react.js"></script>
<script src="packages/react/react_dom.js"></script>
<!--<script src="packages/react/react_with_react_dom_prod.js"></script>-->

<script src="main.dart.js"></script>

<script type="text/javascript">

    //TODO: add ability to pan with keyboard; possibly change to one of these libraries:
    //  https://github.com/anvaka/panzoom
    //  https://github.com/timmywil/panzoom

    var main_view_svg_pan_zoom;

    function setup_splits(show_editor) {
        setup_drag('side-pane', 'main-pane', 'side-main-separator');
        if (show_editor) {
            setup_drag('design-pane', 'editor-pane', 'design-editor-separator');
        } else {
            // need to remove style elements that specify width
            clear_drag('design-pane');
        }
    }

    function setup_svg_panzoom() {
        var eventsHandler;

        eventsHandler = {
            haltEventListeners: ['touchstart', 'touchend', 'touchmove', 'touchleave', 'touchcancel']
            , init: function (options) {
                var instance = options.instance
                    , initialScale = 1
                    , pannedX = 0
                    , pannedY = 0;

                //TODO: bug in code below sets wrong zoom fixed point when using pinch zoom
                //  (assumes container is in upper-left corner of screen)

                // Init Hammer
                // Listen only for pointer and touch events
                this.hammer = Hammer(options.svgElement, {
                    inputClass: Hammer.SUPPORT_POINTER_EVENTS ? Hammer.PointerEventInput : Hammer.TouchInput
                });

                // Enable pinch
                this.hammer.get('pinch').set({enable: true});

                // Handle double tap
                this.hammer.on('doubletap', function (_) {
                    instance.zoomIn();
                });

                // Handle pan
                this.hammer.on('panstart panmove', function (ev) {
                    // On pan start reset panned variables
                    if (ev.type === 'panstart') {
                        pannedX = 0;
                        pannedY = 0;
                    }

                    // Pan only the difference
                    instance.panBy({x: ev.deltaX - pannedX, y: ev.deltaY - pannedY});
                    pannedX = ev.deltaX;
                    pannedY = ev.deltaY;
                });

                // Handle pinch
                this.hammer.on('pinchstart pinchmove', function (ev) {
                    // On pinch start remember initial zoom
                    if (ev.type === 'pinchstart') {
                        initialScale = instance.getZoom();
                        instance.zoomAtPoint(initialScale * ev.scale, {x: ev.center.x, y: ev.center.y});
                    }

                    instance.zoomAtPoint(initialScale * ev.scale, {x: ev.center.x, y: ev.center.y});
                });

                // Prevent moving the page on some devices when panning over SVG
                options.svgElement.addEventListener('touchmove', function (e) {
                    e.preventDefault();
                });
            }

            , destroy: function () {
                this.hammer.destroy()
            }
        };


        // svg-pan-zoom library: https://github.com/ariutta/svg-pan-zoom
        var side_view_svg_pan_zoom = svgPanZoom('#side-view-svg', {
            viewportSelector: "#side-view-svg-viewport",
            zoomScaleSensitivity: 0.3,
            minZoom: 0.05,
            maxZoom: 20,
            customEventsHandler: eventsHandler,
            fit: false,
        });

        main_view_svg_pan_zoom = svgPanZoom('#main-view-svg', {
            viewportSelector: "#main-view-svg-viewport",
            zoomScaleSensitivity: 0.3,
            minZoom: 0.05,
            maxZoom: 20,
            customEventsHandler: eventsHandler,
            fit: false,
        });

        // attempting to remove the dummy node here causes a race condition with the Dart code that clears out
        // DOM children before rendering, so we just leave it in.
        // removeDummy("dummy-elt-side-view");
        // removeDummy("dummy-elt-main-view");




        /*
        // panzoom library: https://github.com/anvaka/panzoom
        var side_view_elt = document.getElementById('side-view-svg-viewport')
        var side_view_svg_pan_zoom = panzoom(side_view_elt, {
            zoomSpeed: 0.065,
            pinchSpeed: 2,
            minZoom: 0.05,
            maxZoom: 20,
            zoomDoubleClickSpeed: 1.2,
        });
        side_view_svg_pan_zoom.moveTo(0,0);

        var main_view_elt = document.getElementById('main-view-svg-viewport')
        var main_view_svg_pan_zoom = panzoom(main_view_elt, {
            zoomSpeed: 0.065,
            pinchSpeed: 2,
            minZoom: 0.05,
            maxZoom: 20,
            zoomDoubleClickSpeed: 1.2,
        });
        main_view_svg_pan_zoom.moveTo(0,0);
        */

    }

    function current_pan() {
        //XXX: dartdevc can handle passing the object pan directly, but the release version requires
        // that we pull out the two pieces of data manually and put them in a list. Not sure why but it took a lot
        // of print statement debugging on the server to identify this.
        var pan = main_view_svg_pan_zoom.getPan();
        return [pan.x,pan.y];
    }

    function current_zoom() {
        return main_view_svg_pan_zoom.getZoom();
    }

    function cache_svg(svg_elt_id) {
        var svg_elt = document.querySelector(svg_elt_id);
        var pablo_svg_elt = Pablo([svg_elt]);
        var imgs = pablo_svg_elt.toImage('png');
        var img = imgs[0];
        return img;

        // var svgString = new XMLSerializer().serializeToString(document.querySelector(svg_elt_id));
        //
        // var canvas = document.getElementById("canvas");
        // var ctx = canvas.getContext("2d");
        // var DOMURL = self.URL || self.webkitURL || self;
        // var img = new Image();
        // var svg = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
        // var url = DOMURL.createObjectURL(svg);
        // img.onload = function() {
        //     ctx.drawImage(img, 0, 0);
        //     var png = canvas.toDataURL("image/png");
        //     document.querySelector('#png-container').innerHTML = '<img src="'+png+'"/>';
        //     DOMURL.revokeObjectURL(png);
        // };
        // img.src = url;
    }

</script>




<!--<script type="text/python" src="compile_script.py"></script>-->

</body>

</html>

